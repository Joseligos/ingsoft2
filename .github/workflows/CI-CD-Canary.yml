name: CI/CD Pipeline con Despliegue Canary

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/serviciudadcali
  COVERAGE_THRESHOLD: 80

jobs:
  # ==============================================================
  # JOB 1: Build, Test y VerificaciÃ³n de Cobertura
  # ==============================================================
  build-and-test:
    name: Build, Tests y Cobertura
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      coverage: ${{ steps.coverage.outputs.percentage }}
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: ğŸ”¢ Generar versiÃ³n
        id: version
        run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ VersiÃ³n generada: $VERSION"

      - name: ğŸ—ï¸ Compilar proyecto
        run: |
          cd ServiCiudadCali
          mvn -B clean compile -DskipTests
          echo "âœ… CompilaciÃ³n exitosa"

      - name: ğŸ§ª Ejecutar pruebas unitarias con cobertura
        run: |
          cd ServiCiudadCali
          mvn -B test jacoco:report
          echo "âœ… Tests ejecutados: $?"

      - name: ğŸ“Š Verificar umbral de cobertura (â‰¥80%)
        id: coverage
        run: |
          cd ServiCiudadCali
          
          # Extraer porcentaje de cobertura del reporte (ya generado por mvn test)
          COVERAGE=$(grep -oP 'Total.*?<td class="ctr2">\K[0-9]+' target/site/jacoco/index.html | head -1)
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Cobertura de cÃ³digo: $COVERAGE%"
          
          # Verificar umbral con mvn verify (incluye jacoco:check)
          if ! mvn verify -DskipTests; then
            echo "âŒ ERROR: VerificaciÃ³n de cobertura fallÃ³"
            exit 1
          fi
          
          if [ "$COVERAGE" -lt "$COVERAGE_THRESHOLD" ]; then
            echo "âŒ ERROR: Cobertura $COVERAGE% es menor que el umbral $COVERAGE_THRESHOLD%"
            exit 1
          fi
          echo "âœ… Cobertura cumple con el umbral requerido"

      - name: ğŸ“¦ Empaquetar aplicaciÃ³n
        run: |
          cd ServiCiudadCali
          mvn -B package -DskipTests
          echo "âœ… AplicaciÃ³n empaquetada"

      - name: ğŸ“¤ Subir artefacto JAR
        uses: actions/upload-artifact@v4
        with:
          name: serviciudadcali-${{ steps.version.outputs.version }}
          path: ServiCiudadCali/target/*.jar
          retention-days: 5

      - name: ğŸ“¤ Subir reporte de cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ServiCiudadCali/target/site/jacoco/
          retention-days: 30

      - name: ğŸ“‹ Publicar reporte de cobertura en PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.percentage }}';
            const threshold = '${{ env.COVERAGE_THRESHOLD }}';
            const status = coverage >= threshold ? 'âœ…' : 'âŒ';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ“Š Reporte de Cobertura de CÃ³digo\n\n` +
                    `${status} **Cobertura:** ${coverage}%\n` +
                    `ğŸ¯ **Umbral requerido:** ${threshold}%\n\n` +
                    `${coverage >= threshold ? 'âœ… Cobertura cumple con los requisitos' : 'âŒ Cobertura por debajo del umbral'}`
            });

  # ==============================================================
  # JOB 2: Build de Imagen Docker
  # ==============================================================
  build-docker-image:
    name: Build Docker Image
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¥ Descargar artefacto JAR
        uses: actions/download-artifact@v4
        with:
          name: serviciudadcali-${{ needs.build-and-test.outputs.version }}
          path: ServiCiudadCali/target/

      - name: ğŸ” Login a Docker Hub (opcional)
        if: env.DOCKERHUB_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: ğŸ—ï¸ Build imagen Docker con Docker Compose
        run: |
          cd ServiCiudadCali
          VERSION=${{ needs.build-and-test.outputs.version }}
          
          # Build con Docker Compose (archivo especÃ­fico para build)
          VERSION=$VERSION docker compose -f docker-compose.build.yml build
          
          # Etiquetar con versiÃ³n y tags adicionales
          docker tag serviciudadcali:latest serviciudadcali:$VERSION
          
          echo "âœ… Imagen Docker creada: serviciudadcali:latest y serviciudadcali:$VERSION"

      - name: ğŸ’¾ Guardar imagen Docker
        run: |
          docker save serviciudadcali:latest | gzip > serviciudadcali-stable.tar.gz
          echo "âœ… Imagen Docker guardada"

      - name: ğŸ“¤ Subir imagen Docker como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-stable
          path: serviciudadcali-stable.tar.gz
          retention-days: 7

  # ==============================================================
  # JOB 3: Despliegue Canary
  # ==============================================================
  canary-deploy:
    name: Despliegue Canary
    needs: [build-and-test, build-docker-image]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¥ Descargar imagen Docker
        uses: actions/download-artifact@v4
        with:
          name: docker-image-stable
          path: .

      - name: ğŸ“¦ Cargar imagen Docker
        run: |
          docker load < serviciudadcali-stable.tar.gz
          docker tag serviciudadcali:latest serviciudadcali:canary
          echo "âœ… Imagen Docker cargada"

      - name: ğŸ³ Levantar versiÃ³n Canary con Docker Compose
        run: |
          cd ServiCiudadCali
          VERSION=${{ needs.build-and-test.outputs.version }}
          
          # Detener canary anterior si existe
          docker compose --profile canary stop app-canary 2>/dev/null || true
          docker compose --profile canary rm -f app-canary 2>/dev/null || true
          
          # Levantar MySQL si no estÃ¡ corriendo
          docker compose up -d mysql
          
          # Esperar que MySQL estÃ© listo
          sleep 10
          
          # Verificar si hay versiÃ³n stable corriendo, si no, desplegarla
          if ! docker ps | grep -q "serviciudadcali-stable"; then
            echo "âš ï¸  No hay versiÃ³n stable, desplegando primero..."
            
            # Si no existe imagen stable, usar latest como base
            if ! docker images | grep -q "serviciudadcali.*stable"; then
              docker tag serviciudadcali:latest serviciudadcali:stable
            fi
            
            # Desplegar stable (versiÃ³n anterior/base)
            VERSION=${VERSION}-stable docker compose up -d app-stable
            echo "âœ… VersiÃ³n stable desplegada en puerto 8080"
            sleep 20
          else
            echo "âœ… VersiÃ³n stable ya estÃ¡ activa en puerto 8080"
          fi
          
          # Levantar Canary con Docker Compose (nueva versiÃ³n)
          VERSION=$VERSION docker compose --profile canary up -d app-canary
          
          echo "âœ… VersiÃ³n Canary desplegada en puerto 8081"
          echo "ğŸ”— URL Stable (vieja): http://localhost:8080"
          echo "ğŸ”— URL Canary (nueva): http://localhost:8081"

      - name: â³ Esperar inicializaciÃ³n (30 segundos)
        run: |
          echo "â³ Esperando a que la aplicaciÃ³n Canary inicie..."
          sleep 30

      - name: ğŸ” Health Check Canary
        run: |
          echo "ğŸ” Verificando health de versiÃ³n Canary..."
          
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f http://localhost:8081/actuator/health 2>/dev/null; then
              echo "âœ… Health check exitoso!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Intento $RETRY_COUNT/$MAX_RETRIES - Reintentando en 5 segundos..."
            sleep 5
          done
          
          echo "âŒ Health check fallÃ³ despuÃ©s de $MAX_RETRIES intentos"
          exit 1

      - name: ğŸ§ª Smoke Tests en Canary
        run: |
          echo "ğŸ§ª Ejecutando smoke tests en versiÃ³n Canary..."
          
          # Test 1: Endpoint principal
          echo "ğŸ“ Test 1: GET /"
          curl -f http://localhost:8081/ || exit 1
          
          # Test 2: Health check
          echo "ğŸ“ Test 2: GET /actuator/health"
          curl -f http://localhost:8081/actuator/health || exit 1
          
          # Test 3: API endpoint (si existe)
          echo "ğŸ“ Test 3: GET /api/deudaConsolidada/..."
          # curl -f http://localhost:8081/api/deudaConsolidada/ObtenerDeudaConsolidadaPorClienteId/1234567890 || echo "âš ï¸  Endpoint de prueba no disponible (esperado)"
          
          echo "âœ… Todos los smoke tests pasaron"

      - name: ğŸ“Š MÃ©tricas de Canary
        run: |
          echo "ğŸ“Š Recolectando mÃ©tricas de versiÃ³n Canary..."
          echo "ğŸ”— URL: http://localhost:8081"
          echo "ğŸ“¦ VersiÃ³n: ${{ needs.build-and-test.outputs.version }}"
          echo "ğŸ“Š Cobertura: ${{ needs.build-and-test.outputs.coverage }}%"
          
          # Obtener informaciÃ³n del contenedor
          docker ps -f name=serviciudadcali-canary --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          # Logs recientes
          echo "\nğŸ“ Ãšltimas 20 lÃ­neas de logs:"
          docker logs --tail 20 serviciudadcali-canary

      - name: â¸ï¸ Mantener Canary activo
        run: |
          echo "âœ… VersiÃ³n Canary desplegada exitosamente"
          echo "ğŸ¯ La versiÃ³n Canary estÃ¡ lista para recibir trÃ¡fico de prueba"
          echo ""
          echo "ğŸ“‹ PrÃ³ximos pasos manuales:"
          echo "  1. Revisar logs: docker logs serviciudadcali-canary"
          echo "  2. Monitorear mÃ©tricas durante 24-48 horas"
          echo "  3. Si todo va bien, ejecutar: make canary-promote"
          echo "  4. Si hay problemas, ejecutar: make canary-rollback"

  # ==============================================================
  # JOB 4: PromociÃ³n a ProducciÃ³n (Manual)
  # ==============================================================
  promote-to-production:
    name: Promover Canary a ProducciÃ³n
    needs: [build-and-test, canary-deploy]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # Nota: Requiere aprobaciÃ³n manual en GitHub Actions
    # Para activar, configurar environment 'production' en Settings > Environments
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¥ Descargar imagen Docker
        uses: actions/download-artifact@v4
        with:
          name: docker-image-stable
          path: .

      - name: ğŸ“¦ Cargar imagen Docker
        run: |
          docker load < serviciudadcali-stable.tar.gz
          # La imagen cargada ya es serviciudadcali:latest (la nueva versiÃ³n)
          echo "âœ… Imagen Docker cargada como serviciudadcali:latest"

      - name: ğŸ”„ Backup versiÃ³n actual (Stable)
        run: |
          cd ServiCiudadCali
          # Si hay un stable corriendo, hacer backup de su imagen
          if docker compose ps app-stable --format json 2>/dev/null | grep -q "app-stable"; then
            CURRENT_IMAGE=$(docker inspect serviciudadcali-stable --format='{{.Image}}' 2>/dev/null || echo "")
            if [ -n "$CURRENT_IMAGE" ]; then
              docker tag $CURRENT_IMAGE serviciudadcali:rollback
              echo "âœ… Backup de versiÃ³n actual guardado como serviciudadcali:rollback"
            else
              echo "âš ï¸  No se pudo hacer backup - no hay imagen actual"
            fi
          else
            echo "â„¹ï¸  No hay versiÃ³n stable previa (primer despliegue)"
          fi

      - name: ğŸš€ Promover Canary a ProducciÃ³n con Docker Compose
        run: |
          cd ServiCiudadCali
          VERSION=${{ needs.build-and-test.outputs.version }}
          
          # Detener stable actual (versiÃ³n vieja)
          docker compose stop app-stable 2>/dev/null || true
          docker compose rm -f app-stable 2>/dev/null || true
          
          # Etiquetar la nueva imagen para stable
          docker tag serviciudadcali:latest serviciudadcali:stable
          
          # Desplegar NUEVA versiÃ³n como stable con Docker Compose
          VERSION=$VERSION docker compose up -d app-stable
          
          echo "âœ… Nueva versiÃ³n promovida a producciÃ³n en puerto 8080"
          echo "ğŸ”— URL ProducciÃ³n: http://localhost:8080"

      - name: â³ Esperar inicializaciÃ³n
        run: sleep 30

      - name: ğŸ” Health Check ProducciÃ³n
        run: |
          echo "ğŸ” Verificando health de versiÃ³n en producciÃ³n..."
          
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
              echo "âœ… ProducciÃ³n estÃ¡ saludable!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Intento $RETRY_COUNT/$MAX_RETRIES - Reintentando en 5 segundos..."
            sleep 5
          done
          
          echo "âŒ Health check de producciÃ³n fallÃ³"
          echo "ğŸ”„ Iniciando rollback automÃ¡tico..."
          exit 1

      - name: ğŸ§¹ Limpiar Canary
        if: success()
        run: |
          cd ServiCiudadCali
          docker compose --profile canary stop app-canary 2>/dev/null || true
          docker compose --profile canary rm -f app-canary 2>/dev/null || true
          echo "âœ… VersiÃ³n Canary removida"

      - name: ğŸ‰ Despliegue completado
        if: success()
        run: |
          echo "ğŸ‰ Â¡Despliegue a producciÃ³n completado exitosamente!"
          echo "ğŸ“¦ VersiÃ³n: ${{ needs.build-and-test.outputs.version }}"
          echo "ğŸ“Š Cobertura: ${{ needs.build-and-test.outputs.coverage }}%"
          echo "ğŸ”— URL: http://localhost:8080"

  # ==============================================================
  # JOB 5: Rollback AutomÃ¡tico (en caso de fallo)
  # ==============================================================
  rollback:
    name: Rollback AutomÃ¡tico
    needs: [promote-to-production]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: ğŸ”„ Ejecutar Rollback con Docker Compose
        run: |
          cd ServiCiudadCali
          echo "ğŸ”„ Iniciando rollback a versiÃ³n anterior..."
          
          # Detener versiÃ³n fallida
          docker compose stop app-stable 2>/dev/null || true
          docker compose rm -f app-stable 2>/dev/null || true
          
          # Restaurar imagen de rollback
          docker tag serviciudadcali:rollback serviciudadcali:latest
          
          # Desplegar versiÃ³n anterior con Docker Compose
          docker compose up -d app-stable
          
          echo "âœ… Rollback completado - VersiÃ³n anterior restaurada"

      - name: ğŸ“§ Notificar fallo
        run: |
          echo "âŒ ALERTA: Despliegue fallÃ³ - Rollback ejecutado"
          echo "ğŸ“‹ Revisar logs para mÃ¡s detalles"
